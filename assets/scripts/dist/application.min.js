/*! player-api main - built with Grunt - DO NOT MODIFY THIS FILE DIRECTLY - built 05-04-2015 */
"use strict";var App=angular.module("App",["ngSanitize","ngResource","spotify","LocalStorageModule","ngCookies","debounce","angular-cache"]);App.value("spotifyConfig",{spotifyHelperUrl:"https://pnmxtktyhx.spotilocal.com:4371/remote/",cachePeriod:60}),App.value("userConfig",{username:"aradnom"}),App.service("getTokens",["$http","$q",function(a,b){var c=b.defer();return a.jsonp("/auth/getplaytokens",{params:{callback:"JSON_CALLBACK"}}).success(function(a,b,d,e){a&&a.success?c.resolve(a.tokens):c.reject(a.error)}).error(function(a,b,d,e){c.reject("Unable to fetch Spotify tokens.")}),c.promise}]),App.service("resources",["$rootScope","spotifyConfig","spotifyApi","CacheFactory","$q",function(a,b,c,d,e){function f(){a.resources.playlists=j.get("playlists"),a.resources.playlists||g()}function g(b,d){c.apiReady?h():a.$on("spotifyApiReady",function(){h()})}function h(){i()}function i(){c.getPlaylists().then(function(b){if(b&&b.total){var d=1;b.items.forEach(function(e){c.getPlaylistTracks(e.id).then(function(c){e.tracksUrl=e.tracks.href,e.tracks=c,d===b.total&&(j.put("playlists",b.items),a.resources.playlists=b.items)})["finally"](function(){d++})})}})}a.resources={playlists:null};var j=d("spotify",{maxAge:60*b.cachePeriod*1e3,deleteOnExpire:"passive",storageMode:"localStorage",onExpire:g});return a.$watchCollection("resources",function(){a.resources.playlists&&a.$broadcast("resourcesReady")}),f(),a.resources}]),App.service("spotifyApi",["Spotify","userConfig","localStorageService","$cookies","$http","$q","$rootScope",function(a,b,c,d,e,f,g){function h(){d.access_token&&(c.set("access_token",d.access_token),d.access_token=""),d.refresh_token&&(c.set("refresh_token",d.refresh_token),d.refresh_token=""),d.expires_in&&(c.set("expires_in",d.expires_in),d.expires_in=""),d.issued_at&&(c.set("issued_at",d.issued_at),d.issued_at=""),d.expires_at&&(c.set("expires_at",d.expires_at),d.expires_at="")}function i(){var a=c.get("access_token"),b=c.get("expires_at");if(a&&b){var d=moment(),e=moment(b);if(d.isBefore(e))return a}return null}function j(){var a=f.defer(),b=c.get("refresh_token");return b?e.jsonp("/auth/refreshtoken",{params:{refresh_token:b,callback:"JSON_CALLBACK"}}).success(function(b){b.success?(d.access_token="",d.expires_in="",d.issued_at="",d.expires_at="",c.set("access_token",b.access_token),c.set("expires_in",b.expires_in),c.set("issued_at",b.issued_at),c.set("expires_at",b.expires_at),a.resolve(b.access_token)):a.reject(b.error)}).error(function(b,c,d,e){a.reject("Error making refresh request: ",b)}):a.reject("Unable to retrieve refresh token."),a.promise}var k={apiReady:!1};h();var l=i();return l?(a.setAuthToken(l),k.apiReady=!0,g.$broadcast("spotifyApiReady")):j().then(function(b){a.setAuthToken(b),k.apiReady=!0,g.$broadcast("spotifyApiReady")})["catch"](function(a){console.error(a)}),k.getPlaylists=function(){return this.apiReady?a.getUserPlaylists(b.username,{limit:50}):void console.error("Spotify API not loaded.")},k.getPlaylistTracks=function(c){var d=f.defer();if(this.apiReady){var e=[];a.getPlaylistTracks(b.username,c).then(function(g){if(g.total)if(e=e.concat(g.items),e.length<g.total){for(var h=[],i=g.limit;i<g.total;i+=g.limit)h.push(a.getPlaylistTracks(b.username,c,{offset:i}));f.all(h).then(function(a){a&&a.length&&(e=e.concat.apply(e,a.map(function(a){return a.items}))),d.resolve(e)})}else d.resolve(e);else d.reject("Playlist contains no tracks.")})["catch"](function(a){d.reject(a)})}else console.error("Spotify API not loaded.");return d.promise},k.search=function(b){return this.apiReady?a.search(b,"album,artist,track"):void console.error("Spotify API not loaded.")},k}]),App.service("spotifyHelper",["$http","$q","getTokens","$rootScope","templates",function(a,b,c,d,e){function f(a){var b=_.template(e.spotifyCommandUrl);return encodeURI(b(a))}function g(c){var d=b.defer();return a.get(c,{params:{callback:"JSON_CALLBACK"}}).success(function(a,b,c,e){d.resolve(a)}).error(function(a,b,c,e){d.reject("Unable to send Spotify command.")}),d.promise}var h={};return c.then(function(a){h=a,d.$broadcast("spotifyHelperLoaded")})["catch"](function(a){console.error(a),d.$broadcast("spotifyHelperError")}),{play:function(a){if(h.csrf&&h.access&&a){var b=f({action:"play",csrf:h.csrf,oauth:h.access,suffix:"uri="+a+"&context="+a});return g(b)}console.error("Spotify Helper must be loaded before issuing commands.")},pause:function(){if(h.csrf&&h.access){var a=f({action:"pause",csrf:h.csrf,oauth:h.access,suffix:"pause=true"});return g(a)}console.error("Spotify Helper must be loaded before issuing commands.")},status:function(){if(h.csrf&&h.access){var a=f({action:"status",csrf:h.csrf,oauth:h.access,suffix:"returnon=login,logout,play,pause,error,ap&returnafter=60"});return g(a)}console.error("Spotify Helper must be loaded before issuing commands.")}}}]),App.service("templates",["spotifyConfig",function(a){return{spotifyCommandUrl:a.spotifyHelperUrl+"<%= action %>.json?csrf=<%= csrf %>&oauth=<%= oauth %>&<%= suffix %>&ref=&cors"}}]),App.service("utility",[function(){return{getPlayingTimeString:function(a,b){b=b||"s","ms"===b&&(a/=1e3),a=Math.round(a);var c=parseInt(a/60).toString(),d=(a%60).toString();return 10>d&&(d="0"+d),c+":"+d}}}]),App.controller("ActivePlaylist",["$scope","$element",function(a,b){}]),App.controller("Main",["$scope","$element","spotifyHelper","$timeout","Spotify",function(a,b,c,d,e){a.safeApply=function(a){var b=this.$root.$$phase;"$apply"===b||"$digest"===b?a&&"function"==typeof a&&a():this.$apply(a)}}]),App.controller("Player",["$scope","$rootScope","$element","spotifyHelper","utility","$interval",function(a,b,c,d,e,f){function g(){d.pause().then(function(a){a&&!a.playing?j():console.log(a)})}function h(a){d.play(a.uri).then(function(b){b.playing?(i(a,b),n=a):console.log(b)})}function i(b,c){console.log(b,c),a.playing=!0,l(b)}function j(){a.playing=!1,m()}function k(){a.currentTime=null,a.timeRemaining=null,a.progressStyles={"transition-duration":"","-moz-transition-duration":"","-webkit-transition-duration":"","-o-transition-duration":"","-ms-transition-duration":""},a.progressStyles.width="0",a.safeApply(),o&&(f.cancel(o),o=null),a.reverseRemaining=!1}function l(b){k();var c=Math.round(b.duration_ms/1e3);a.progressStyles={"transition-duration":c.toString()+"s","-moz-transition-duration":c.toString()+"s","-webkit-transition-duration":c.toString()+"s","-o-transition-duration":c.toString()+"s","-ms-transition-duration":c.toString()+"s"},a.progressStyles.width="100%";var d=0,g=c;a.currentTime=e.getPlayingTimeString(d),a.timeRemaining="-"+e.getPlayingTimeString(g),o=f(function(){c>d&&(a.currentTime=e.getPlayingTimeString(++d),a.timeRemaining="-"+e.getPlayingTimeString(--g),d/c>.3&&(a.reverseRemaining=!0))},1e3)}function m(){k()}var n=null,o=null;a.playing=!1,b.$on("playTrack",function(a,b){h(b)}),a.playPause=function(){a.playing?g():n&&h(n)}}]),App.controller("Playlists",["$scope","$rootScope","$element","spotifyApi","resources","spotifyConfig",function(a,b,c,d,e,f){function g(b){var c=[];b.forEach(function(a){c.push({id:a.id,image:a.images&&a.images.length?a.images[0].url:null,name:a.name,tracks:a.tracks})}),a.playlists=c}a.$on("resourcesReady",function(){g(e.playlists)}),a.showPlaylist=function(b,c){var d=$(b.currentTarget).parent(),e=d.find(".playlist__tracks");if(c.activeTracks)e.velocity("slideUp",{duration:50*c.tracks.length,easing:"easeOutExpo",complete:function(){c.activeTracks=null,a.safeApply()}});else if(c.tracks&&c.tracks.length){c.activeTracks=c.tracks,a.safeApply();var f=a.$on("ngRepeatFinished",function(){e.velocity("slideDown",{duration:50*c.tracks.length,easing:"easeOutExpo"}),f()})}},a.playTrack=function(a){b.$broadcast("playTrack",a)}}]),App.controller("Search",["$scope","$element","spotifyApi","debounce",function(a,b,c,d){a.search={},a.runSearch=d(function(){a.search.query&&c.search(a.search.query).then(function(a){console.log(a)})},200)}]),App.controller("Sidebar",["$scope","$element","Spotify",function(a,b,c){}]),App.directive("repeatDoneEvent",function(){return function(a,b,c){a.$last&&a.$evalAsync(function(){a.$emit("ngRepeatFinished",b)})}});