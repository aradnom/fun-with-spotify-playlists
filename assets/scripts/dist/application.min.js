/*! player-api main - built with Grunt - DO NOT MODIFY THIS FILE DIRECTLY - built 05-10-2015 */
"use strict";var App=angular.module("App",["ngSanitize","ngResource","spotify","LocalStorageModule","ngCookies","debounce","angular-cache","ngDragDrop"]);App.value("spotifyConfig",{spotifyHelperUrl:"https://pnmxtktyhx.spotilocal.com:4371/remote/",cachePeriod:60}),App.value("userConfig",{username:"aradnom"}),App.value("dragAndDrop",{currentTrack:null}),App.service("getTokens",["$http","$q",function(a,b){var c=b.defer();return a.jsonp("/auth/getplaytokens",{params:{callback:"JSON_CALLBACK"}}).success(function(a,b,d,e){a&&a.success?c.resolve(a.tokens):c.reject(a.error)}).error(function(a,b,d,e){c.reject("Unable to fetch Spotify tokens.")}),c.promise}]),App.service("resources",["$rootScope","spotifyConfig","spotifyApi","spotifyUtility","CacheFactory","$q",function(a,b,c,d,e,f){function g(){a.resources.playlists=l.get("playlists"),a.resources.playlists||h()}function h(b,d){c.apiReady?i():a.$on("spotifyApiReady",function(){i()})}function i(){j()}function j(){c.getPlaylists().then(function(b){if(b&&b.total){var d=1;b.items.forEach(function(e){c.getPlaylistTracks(e.id).then(function(c){if(e.tracksUrl=e.tracks.href,e.tracks=c,d===b.total){var f=k(b.items);l.put("playlists",f),a.resources.playlists=f}})["finally"](function(){d++})})}})}function k(a){return a.forEach(function(a){a.tracks&&a.tracks.length&&a.tracks.forEach(function(a){var b=a.track.name,c=a.track.artists.map(function(a){return a.name});a.track.artist_string=c.join(", "),a.track.playlist_title=a.track.artist_string+" - "+b,a.track.thumbnail=d.getTrackThumbnail(a.track,300,!0)})}),a}a.resources={playlists:null};var l=e("spotify",{maxAge:60*b.cachePeriod*1e3,deleteOnExpire:"passive",storageMode:"localStorage",onExpire:h});return a.$watchCollection("resources",function(){a.resources.playlists&&a.$broadcast("resourcesReady")}),g(),a.resources}]),App.service("spotifyApi",["Spotify","userConfig","localStorageService","$cookies","$http","$q","$rootScope",function(a,b,c,d,e,f,g){function h(){d.access_token&&(c.set("access_token",d.access_token),d.access_token=""),d.refresh_token&&(c.set("refresh_token",d.refresh_token),d.refresh_token=""),d.expires_in&&(c.set("expires_in",d.expires_in),d.expires_in=""),d.issued_at&&(c.set("issued_at",d.issued_at),d.issued_at=""),d.expires_at&&(c.set("expires_at",d.expires_at),d.expires_at="")}function i(){var a=c.get("access_token"),b=c.get("expires_at");if(a&&b){var d=moment(),e=moment(b);if(d.isBefore(e))return a}return null}function j(){var a=f.defer(),b=c.get("refresh_token");return b?e.jsonp("/auth/refreshtoken",{params:{refresh_token:b,callback:"JSON_CALLBACK"}}).success(function(b){b.success?(d.access_token="",d.expires_in="",d.issued_at="",d.expires_at="",c.set("access_token",b.access_token),c.set("expires_in",b.expires_in),c.set("issued_at",b.issued_at),c.set("expires_at",b.expires_at),a.resolve(b.access_token)):a.reject(b.error)}).error(function(b,c,d,e){a.reject("Error making refresh request: ",b)}):a.reject("Unable to retrieve refresh token."),a.promise}var k={apiReady:!1};h();var l=i();return l?(a.setAuthToken(l),k.apiReady=!0,g.$broadcast("spotifyApiReady")):j().then(function(b){a.setAuthToken(b),k.apiReady=!0,g.$broadcast("spotifyApiReady")})["catch"](function(a){console.error(a)}),k.getPlaylists=function(){return this.apiReady?a.getUserPlaylists(b.username,{limit:50}):void console.error("Spotify API not loaded.")},k.getPlaylistTracks=function(c){var d=f.defer();if(this.apiReady){var e=[];a.getPlaylistTracks(b.username,c).then(function(g){if(g.total)if(e=e.concat(g.items),e.length<g.total){for(var h=[],i=g.limit;i<g.total;i+=g.limit)h.push(a.getPlaylistTracks(b.username,c,{offset:i}));f.all(h).then(function(a){a&&a.length&&(e=e.concat.apply(e,a.map(function(a){return a.items}))),d.resolve(e)})}else d.resolve(e);else d.reject("Playlist contains no tracks.")})["catch"](function(a){d.reject(a)})}else console.error("Spotify API not loaded.");return d.promise},k.search=function(b){return this.apiReady?a.search(b,"album,artist,track"):void console.error("Spotify API not loaded.")},k}]),App.service("spotifyHelper",["$http","$q","getTokens","$rootScope","templates",function(a,b,c,d,e){function f(a){var b=_.template(e.spotifyCommandUrl);return encodeURI(b(a))}function g(c){var d=b.defer();return a.get(c,{params:{callback:"JSON_CALLBACK"}}).success(function(a,b,c,e){d.resolve(a)}).error(function(a,b,c,e){d.reject("Unable to send Spotify command.")}),d.promise}var h={};return c.then(function(a){h=a,d.$broadcast("spotifyHelperLoaded")})["catch"](function(a){console.error(a),d.$broadcast("spotifyHelperError")}),{play:function(a){if(h.csrf&&h.access&&a){var b=f({action:"play",csrf:h.csrf,oauth:h.access,suffix:"uri="+a+"&context="+a});return g(b)}console.error("Spotify Helper must be loaded before issuing commands.")},pause:function(){if(h.csrf&&h.access){var a=f({action:"pause",csrf:h.csrf,oauth:h.access,suffix:"pause=true"});return g(a)}console.error("Spotify Helper must be loaded before issuing commands.")},status:function(){if(h.csrf&&h.access){var a=f({action:"status",csrf:h.csrf,oauth:h.access,suffix:"returnon=login,logout,play,pause,error,ap&returnafter=60"});return g(a)}console.error("Spotify Helper must be loaded before issuing commands.")}}}]),App.service("spotifyUtility",[function(){return{getTrackThumbnail:function(a,b,c){if(a.album&&a.album.images&&a.album.images.length){var d=a.album.images.filter(function(a){return a.width===b});return d.length?d[0].url:a.album.images[0].url}return null}}}]),App.service("templates",["spotifyConfig",function(a){return{spotifyCommandUrl:a.spotifyHelperUrl+"<%= action %>.json?csrf=<%= csrf %>&oauth=<%= oauth %>&<%= suffix %>&ref=&cors"}}]),App.service("utility",[function(){return{getPlayingTimeString:function(a,b){b=b||"s","ms"===b&&(a/=1e3),a=Math.round(a);var c=parseInt(a/60).toString(),d=(a%60).toString();return 10>d&&(d="0"+d),c+":"+d}}}]),App.controller("Dropzone",["$scope","$element",function(a,b){a.active=!1;var c=null;a.$on("dragStart",function(){a.active=!0,a.safeApply()}),a.$on("dragStop",function(b,d){c=d.track,a.active=!1,a.safeApply()}),a.dragDrop=function(){a.$emit("trackDropped",c),c=null,a.hover=!1,a.safeApply()},a.dragOver=function(){a.hover=!0,a.safeApply()},a.dragOut=function(){a.hover=!1,a.safeApply()}}]),App.controller("Main",["$scope","$element","spotifyHelper","$timeout","Spotify",function(a,b,c,d,e){a.safeApply=function(a){var b=this.$root.$$phase;"$apply"===b||"$digest"===b?a&&"function"==typeof a&&a():this.$apply(a)}}]),App.controller("MasterPlaylist",["$scope","$element","$rootScope","localStorageService","dragAndDrop",function(a,b,c,d,e){function f(b,c){"undefined"!=typeof c?a.tracks.splice(c,0,b):a.tracks.push(b),d.set("playerMasterPlaylist",a.tracks)}function g(b){a.tracks.splice(b,1),d.set("playerMasterPlaylist",a.tracks)}a.currentTrack=null,a.tracks=d.get("playerMasterPlaylist"),a.tracks||(a.tracks=[]);var h=-1;a.playTrack=function(a){c.$broadcast("playTrack",a)},a.removeTrack=function(a){g(a)},a.dragDrop=function(c,d){var i=b.find(".master-playlist__tracks__track");if(i.length){var j=i.map(function(){return Math.abs(d.offset.top-$(this).offset().top)}),k=j.index(Math.min.apply(j,j)),l=$(i[k]).offset().top;d.offset.top-l>=0?(f(e.currentTrack,k+1),h>-1&&h>k+1&&h++):(f(e.currentTrack,k),h>-1&&h>k&&h++)}else f(e.currentTrack);h>-1&&(g(h),h=-1),e.currentTrack=null,a.hover=!1,a.safeApply()},a.dragOver=function(){a.hover=!0,a.safeApply()},a.dragOut=function(){a.hover=!1,a.safeApply()},a.dragStart=function(a,b,d,f){c.$broadcast("dragStart",d),e.currentTrack=d,h=f},a.dragStop=function(a,b,d){c.$broadcast("dragStop",d)},a.$on("playTrack",function(b,c){a.currentTrack=c}),a.$on("playerPlaying",function(){a.playing=!0}),a.$on("playerStopped",function(){a.playing=!1})}]),App.controller("Player",["$scope","$rootScope","$element","spotifyHelper","utility","$interval","$timeout",function(a,b,c,d,e,f,g){function h(){d.pause().then(function(a){a&&!a.playing?k():console.log(a)})}function i(a){d.play(a.uri).then(function(b){b.playing?(j(a,b),o=a):console.log(b)})}function j(c,d){a.playing=!0,m(c),b.$broadcast("playerPlaying")}function k(){a.playing=!1,n(),b.$broadcast("playerStopped")}function l(){var b=c.find(".player__progress__inner");a.currentTime=null,a.timeRemaining=null,b.css({"transition-duration":"0","-moz-transition-duration":"0","-webkit-transition-duration":"0","-o-transition-duration":"0","-ms-transition-duration":"0"}),b.width(0).hide().show(0),p&&(f.cancel(p),p=null),a.reverseRemaining=!1}function m(b){var d=c.find(".player__progress__inner");l();var g=Math.round(b.duration_ms/1e3);d.css({"transition-duration":g.toString()+"s","-moz-transition-duration":g.toString()+"s","-webkit-transition-duration":g.toString()+"s","-o-transition-duration":g.toString()+"s","-ms-transition-duration":g.toString()+"s"}),d.width("100%");var h=0,i=g;a.currentTime=e.getPlayingTimeString(h),a.timeRemaining="-"+e.getPlayingTimeString(i),p=f(function(){g>h&&(a.currentTime=e.getPlayingTimeString(++h),a.timeRemaining="-"+e.getPlayingTimeString(--i),h/g>.3&&(a.reverseRemaining=!0))},1e3)}function n(){l()}var o=null,p=null;a.playing=!1,b.$on("playTrack",function(a,b){i(b)}),a.playPause=function(){a.playing?h():o&&i(o)}}]),App.controller("Playlists",["$scope","$rootScope","$element","spotifyApi","resources","spotifyConfig","dragAndDrop",function(a,b,c,d,e,f,g){function h(b){var c=[];b.forEach(function(a){c.push({id:a.id,image:a.images&&a.images.length?a.images[0].url:null,name:a.name,tracks:a.tracks})}),a.playlists=c}a.$on("resourcesReady",function(){h(e.playlists)}),a.showPlaylist=function(b,c){var d=$(b.currentTarget).parent(),e=d.find(".playlist__tracks");if(c.activeTracks)e.velocity("slideUp",{duration:50*c.tracks.length,easing:"easeOutExpo",complete:function(){c.activeTracks=null,a.safeApply()}});else if(c.tracks&&c.tracks.length){c.activeTracks=c.tracks,a.safeApply();var f=a.$on("ngRepeatFinished",function(){e.velocity("slideDown",{duration:50*c.tracks.length,easing:"easeOutExpo"}),f()})}},a.playTrack=function(a){b.$broadcast("playTrack",a)},a.dragStart=function(a,c,d){b.$broadcast("dragStart",d),g.currentTrack=d.track},a.dragStop=function(a,c,d){b.$broadcast("dragStop",d)}}]),App.controller("Search",["$scope","$element","spotifyApi","debounce",function(a,b,c,d){function e(){g.velocity("stop",!0).velocity("slideDown",{duration:200})}function f(){g.velocity("stop",!0).velocity("slideUp",{duration:200,complete:function(){a.results=null}})}a.search={};var g=b.find(".search__results");a.runSearch=d(function(){a.search.query?c.search(a.search.query).then(function(b){var c=(b.tracks.total>0?1:0)+(b.artists.total>0?1:0)+(b.albums.total>0?1:0),d=0,f=a.$on("ngRepeatFinished",function(){d++,d===c&&(f(),e())});a.results=b}):f()},300),a.closeSearch=function(){f()}}]),App.controller("TrackSidebar",["$scope","$element","Spotify",function(a,b,c){}]),App.directive("repeatDoneEvent",function(){return function(a,b,c){a.$last&&a.$evalAsync(function(){a.$emit("ngRepeatFinished",b)})}});