/*! player-api main - built with Grunt - DO NOT MODIFY THIS FILE DIRECTLY - built 05-12-2015 */
"use strict";var App=angular.module("App",["ngSanitize","ngResource","spotify","LocalStorageModule","ngCookies","debounce","angular-cache","ngDragDrop"]);App.value("spotifyConfig",{spotifyHelperUrl:"https://pnmxtktyhx.spotilocal.com:4371/remote/",cachePeriod:60}),App.value("userConfig",{username:"aradnom"}),App.value("dragAndDrop",{currentTrack:null}),App.service("getTokens",["$http","$q",function(a,b){var c=b.defer();return a.jsonp("/auth/getplaytokens",{params:{callback:"JSON_CALLBACK"}}).success(function(a,b,d,e){a&&a.success?c.resolve(a.tokens):c.reject(a.error)}).error(function(a,b,d,e){c.reject("Unable to fetch Spotify tokens.")}),c.promise}]),App.service("resources",["$rootScope","spotifyConfig","spotifyApi","spotifyUtility","CacheFactory","$q",function(a,b,c,d,e,f){function g(){a.resources.playlists=m.get("playlists"),a.resources.library=m.get("library"),a.resources.playlists&&a.resources.library||h()}function h(b,d){c.apiReady?i():a.$on("spotifyApiReady",function(){i()})}function i(){j(),k()}function j(){c.getPlaylists().then(function(b){if(b&&b.total){var d=1;b.items.forEach(function(e){c.getPlaylistTracks(e.id).then(function(c){if(e.tracksUrl=e.tracks.href,e.tracks=c,d===b.total){var f=l(b.items);m.put("playlists",f),a.resources.playlists=f}})["finally"](function(){d++})})}})}function k(){c.getLibrary().then(function(b){b.forEach(function(a){d.formatTrack(a)}),m.put("library",b),a.resources.library=b})}function l(a){return a.forEach(function(a){a.tracks&&a.tracks.length&&a.tracks.forEach(function(a){d.formatTrack(a)})}),a}a.resources={playlists:null,library:null};var m=e("spotify",{maxAge:60*b.cachePeriod*1e3,deleteOnExpire:"passive",storageMode:"localStorage",onExpire:h});return a.$watchCollection("resources",function(){a.resources.playlists&&a.resources.library&&a.$broadcast("resourcesReady")}),g(),a.resources}]),App.service("spotifyApi",["Spotify","userConfig","localStorageService","$cookies","$http","$q","$rootScope",function(a,b,c,d,e,f,g){function h(){d.access_token&&(c.set("access_token",d.access_token),d.access_token=""),d.refresh_token&&(c.set("refresh_token",d.refresh_token),d.refresh_token=""),d.expires_in&&(c.set("expires_in",d.expires_in),d.expires_in=""),d.issued_at&&(c.set("issued_at",d.issued_at),d.issued_at=""),d.expires_at&&(c.set("expires_at",d.expires_at),d.expires_at="")}function i(){var a=c.get("access_token"),b=c.get("expires_at");if(a&&b){var d=moment(),e=moment(b);if(d.isBefore(e))return a}return null}function j(){var a=f.defer(),b=c.get("refresh_token");return b?e.jsonp("/auth/refreshtoken",{params:{refresh_token:b,callback:"JSON_CALLBACK"}}).success(function(b){b.success?(d.access_token="",d.expires_in="",d.issued_at="",d.expires_at="",c.set("access_token",b.access_token),c.set("expires_in",b.expires_in),c.set("issued_at",b.issued_at),c.set("expires_at",b.expires_at),a.resolve(b.access_token)):a.reject(b.error)}).error(function(b,c,d,e){a.reject("Error making refresh request: ",b)}):a.reject("Unable to retrieve refresh token."),a.promise}var k={apiReady:!1};h();var l=i();return l?(a.setAuthToken(l),k.apiReady=!0,g.$broadcast("spotifyApiReady")):j().then(function(b){a.setAuthToken(b),k.apiReady=!0,g.$broadcast("spotifyApiReady")})["catch"](function(a){console.error(a)}),k.getLibrary=function(){var b=f.defer();if(this.apiReady){var c=[];a.getSavedUserTracks({limit:50}).then(function(d){if(d.total)if(c=c.concat(d.items),c.length<d.total){for(var e=[],g=d.limit;g<d.total;g+=d.limit)e.push(a.getSavedUserTracks({offset:g,limit:d.limit}));f.all(e).then(function(a){a&&a.length&&(c=c.concat.apply(c,a.map(function(a){return a.items}))),b.resolve(c)})}else b.resolve(c);else b.reject("User library contains no tracks.")})["catch"](function(a){b.reject(a)})}else console.error("Spotify API not loaded.");return b.promise},k.getPlaylists=function(){return this.apiReady?a.getUserPlaylists(b.username,{limit:50}):void console.error("Spotify API not loaded.")},k.getPlaylistTracks=function(c){var d=f.defer();if(this.apiReady){var e=[];a.getPlaylistTracks(b.username,c,{limit:50}).then(function(g){if(g.total)if(e=e.concat(g.items),e.length<g.total){for(var h=[],i=g.limit;i<g.total;i+=g.limit)h.push(a.getPlaylistTracks(b.username,c,{offset:i,limit:g.limit}));f.all(h).then(function(a){a&&a.length&&(e=e.concat.apply(e,a.map(function(a){return a.items}))),d.resolve(e)})}else d.resolve(e);else d.reject("Playlist contains no tracks.")})["catch"](function(a){d.reject(a)})}else console.error("Spotify API not loaded.");return d.promise},k.search=function(b){return this.apiReady?a.search(b,"album,artist,track"):void console.error("Spotify API not loaded.")},k}]),App.service("spotifyHelper",["$http","$q","getTokens","$rootScope","templates",function(a,b,c,d,e){function f(a){var b=_.template(e.spotifyCommandUrl);return encodeURI(b(a))}function g(c){var d=b.defer();return a.get(c,{params:{callback:"JSON_CALLBACK"}}).success(function(a,b,c,e){d.resolve(a)}).error(function(a,b,c,e){d.reject("Unable to send Spotify command.")}),d.promise}var h={};return c.then(function(a){h=a,d.$broadcast("spotifyHelperLoaded")})["catch"](function(a){console.error(a),d.$broadcast("spotifyHelperError")}),{play:function(a){if(h.csrf&&h.access&&a){var b=f({action:"play",csrf:h.csrf,oauth:h.access,suffix:"uri="+a+"&context="+a});return g(b)}console.error("Spotify Helper must be loaded before issuing commands.")},pause:function(){if(h.csrf&&h.access){var a=f({action:"pause",csrf:h.csrf,oauth:h.access,suffix:"pause=true"});return g(a)}console.error("Spotify Helper must be loaded before issuing commands.")},status:function(){if(h.csrf&&h.access){var a=f({action:"status",csrf:h.csrf,oauth:h.access,suffix:"returnon=login,logout,play,pause,error,ap&returnafter=60"});return g(a)}console.error("Spotify Helper must be loaded before issuing commands.")}}}]),App.service("spotifyUtility",[function(){var a={};return a.getTrackThumbnail=function(a,b,c){if(a.album&&a.album.images&&a.album.images.length){var d=a.album.images.filter(function(a){return a.width===b});return d.length?d[0].url:a.album.images[0].url}return null},a.formatTrack=function(b){b.track&&(b=b.track);var c=b.name,d=b.artists.map(function(a){return a.name});return b.artist_string=d.join(", "),b.playlist_title=b.artist_string+" - "+c,b.thumbnail=a.getTrackThumbnail(b,300,!0),b},a}]),App.service("templates",["spotifyConfig",function(a){return{spotifyCommandUrl:a.spotifyHelperUrl+"<%= action %>.json?csrf=<%= csrf %>&oauth=<%= oauth %>&<%= suffix %>&ref=&cors"}}]),App.service("utility",[function(){return{getPlayingTimeString:function(a,b){b=b||"s","ms"===b&&(a/=1e3),a=Math.round(a);var c=parseInt(a/60).toString(),d=(a%60).toString();return 10>d&&(d="0"+d),c+":"+d}}}]),App.controller("Dropzone",["$scope","$element",function(a,b){a.active=!1;var c=null;a.$on("dragStart",function(){a.active=!0,a.safeApply()}),a.$on("dragStop",function(b,d){c=d.track,a.active=!1,a.safeApply()}),a.dragDrop=function(){a.$emit("trackDropped",c),c=null,a.hover=!1,a.safeApply()},a.dragOver=function(){a.hover=!0,a.safeApply()},a.dragOut=function(){a.hover=!1,a.safeApply()}}]),App.controller("Main",["$scope","$element","spotifyHelper","$timeout","Spotify",function(a,b,c,d,e){a.safeApply=function(a){var b=this.$root.$$phase;"$apply"===b||"$digest"===b?a&&"function"==typeof a&&a():this.$apply(a)}}]),App.controller("MasterPlaylist",["$scope","$element","$rootScope","localStorageService","dragAndDrop",function(a,b,c,d,e){function f(b,c){"undefined"!=typeof c?a.tracks.splice(c,0,b):a.tracks.push(b),d.set("playerMasterPlaylist",a.tracks)}function g(b){a.tracks.splice(b,1),d.set("playerMasterPlaylist",a.tracks)}function h(){var b=a.tracks.filter(function(a){return!a.unplayable});if(b.length){var d=b.indexOf(a.currentTrack);d>-1&&b[d+1]&&c.$broadcast("playTrack",b[d+1])}}function i(){var b=a.tracks.filter(function(a){return!a.unplayable});if(b.length){var d=b.indexOf(a.currentTrack);d>-1&&b[d-1]&&c.$broadcast("playTrack",b[d-1])}}a.currentTrack=null,a.tracks=d.get("playerMasterPlaylist"),a.tracks||(a.tracks=[]);var j=-1;a.playTrack=function(a){a.unplayable||c.$broadcast("playTrack",a)},a.removeTrack=function(a){g(a)},a.dragDrop=function(c,d){var h=b.find(".master-playlist__tracks__track");if(h.length){var i=h.map(function(){return Math.abs(d.offset.top-$(this).offset().top)}),k=i.index(Math.min.apply(i,i)),l=$(h[k]).offset().top;d.offset.top-l>=0?(f(e.currentTrack,k+1),j>-1&&j>k+1&&j++):(f(e.currentTrack,k),j>-1&&j>k&&j++)}else f(e.currentTrack);j>-1&&(g(j),j=-1),e.currentTrack=null,a.hover=!1,a.safeApply()},a.dragOver=function(){a.hover=!0,a.safeApply()},a.dragOut=function(){a.hover=!1,a.safeApply()},a.dragStart=function(a,b,d,f){c.$broadcast("dragStart",d),e.currentTrack=d,j=f},a.dragStop=function(a,b,d){c.$broadcast("dragStop",d)},a.$on("trackEnded",function(){h()}),a.$on("playTrack",function(b,c){a.currentTrack=c,a.tracks.filter(function(a){return a.active}).forEach(function(a){a.active=!1}),c.active=!0}),a.$on("nextTrack",function(){h()}),a.$on("previousTrack",function(){i()}),a.$on("playerPlaying",function(){a.currentTrack.active=!0,a.playing=!0}),a.$on("playerStopped",function(){a.playing=!1,a.tracks.filter(function(a){return a.active}).forEach(function(a){a.active=!1})}),a.$on("addToMasterPlaylist",function(a,b){f(b,0)}),a.$on("unplayableTrack",function(b,c){c.unplayable=!0,d.set("playerMasterPlaylist",a.tracks)})}]),App.controller("Player",["$scope","$rootScope","$element","spotifyHelper","utility","$interval","$timeout",function(a,b,c,d,e,f,g){function h(){d.pause().then(function(a){a&&!a.playing?k():console.error(a)})}function i(a){d.play(a.uri).then(function(c){c.playing?(j(a,c),o=a):(c.error&&c.error.type&&"4303"===c.error.type&&b.$broadcast("unplayableTrack",a),console.error(c))})}function j(c,d){a.playing=!0,m(c),b.$broadcast("playerPlaying")}function k(){a.playing=!1,n(),b.$broadcast("playerStopped")}function l(){var b=c.find(".player__progress__inner");a.currentTime=null,a.timeRemaining=null,b.css({"transition-duration":"0","-moz-transition-duration":"0","-webkit-transition-duration":"0","-o-transition-duration":"0","-ms-transition-duration":"0"}),b.width(0).hide().show(0),p&&(f.cancel(p),p=null),a.reverseRemaining=!1}function m(d){var g=c.find(".player__progress__inner");l();var i=Math.round(d.duration_ms/1e3);g.css({"transition-duration":i.toString()+"s","-moz-transition-duration":i.toString()+"s","-webkit-transition-duration":i.toString()+"s","-o-transition-duration":i.toString()+"s","-ms-transition-duration":i.toString()+"s"}),g.width("100%");var j=0,k=i;a.currentTime=e.getPlayingTimeString(j),a.timeRemaining="-"+e.getPlayingTimeString(k),p=f(function(){i>j&&(a.currentTime=e.getPlayingTimeString(++j),a.timeRemaining="-"+e.getPlayingTimeString(--k),j/i>.3&&(a.reverseRemaining=!0),j+1>i&&(b.$broadcast("trackEnded"),h()))},1e3)}function n(){l()}var o=null,p=null;a.playing=!1,b.$on("playTrack",function(a,b){i(b)}),a.playPause=function(){a.playing?h():o&&i(o)},a.nextTrack=function(){b.$broadcast("nextTrack")},a.previousTrack=function(){b.$broadcast("previousTrack")}}]),App.controller("Playlists",["$scope","$rootScope","$element","spotifyApi","resources","spotifyConfig","dragAndDrop","spotifyUtility",function(a,b,c,d,e,f,g,h){function i(b){var c=[];b.forEach(function(a){c.push({id:a.id,image:a.images&&a.images.length?a.images[0].url:null,name:a.name,tracks:a.tracks})}),a.playlists=c}a.$on("resourcesReady",function(){i(e.playlists)}),a.showPlaylist=function(b,c){var d=$(b.currentTarget).parent(),e=d.find(".playlist__tracks");if(c.activeTracks)e.velocity("slideUp",{duration:.5*Math.log(c.tracks.length)*1e3,easing:"easeOutExpo",complete:function(){c.activeTracks=null,a.safeApply()}});else if(c.tracks&&c.tracks.length){c.activeTracks=c.tracks,a.safeApply();var f=a.$on("ngRepeatFinished",function(){e.velocity("slideDown",{duration:.5*Math.log(c.tracks.length)*1e3,easing:"easeOutExpo"}),f()})}},a.addToPlaylist=function(a){b.$broadcast("addToMasterPlaylist",h.formatTrack(a))},a.dragStart=function(a,c,d){b.$broadcast("dragStart",d),g.currentTrack=d.track},a.dragStop=function(a,c,d){b.$broadcast("dragStop",d)}}]),App.controller("Search",["$scope","$rootScope","$element","spotifyApi","debounce","spotifyUtility",function(a,b,c,d,e,f){function g(){i.velocity("stop",!0).velocity("slideDown",{duration:200})}function h(){i.velocity("stop",!0).velocity("slideUp",{duration:200,complete:function(){a.results=null}})}a.search={};var i=c.find(".search__results");a.runSearch=e(function(){a.search.query?d.search(a.search.query).then(function(b){var c=(b.tracks.total>0?1:0)+(b.artists.total>0?1:0)+(b.albums.total>0?1:0),d=0,e=a.$on("ngRepeatFinished",function(){d++,d===c&&(e(),g())});a.results=b}):h()},300),a.closeSearch=function(){h()},a.addToPlaylist=function(a){b.$broadcast("addToMasterPlaylist",f.formatTrack(a))}}]),App.controller("Sidebar",["$scope","$element",function(a,b){a.toggleSidebar=function(){a.closed=!a.closed}}]),App.directive("repeatDoneEvent",function(){return function(a,b,c){a.$last&&a.$evalAsync(function(){a.$emit("ngRepeatFinished",b)})}});